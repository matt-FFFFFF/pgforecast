<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü™Ç PG Forecast ‚Äî Paragliding Weather</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root {
    --bg: #0f1419;
    --card: #1a2332;
    --border: #2d3748;
    --text: #e2e8f0;
    --muted: #718096;
    --accent: #4fd1c5;
    --good: #48bb78;
    --warn: #ecc94b;
    --bad: #f56565;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
  
  .header { padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid var(--border); }
  .header h1 { font-size: 1.5rem; font-weight: 600; }
  .header h1 span { font-size: 1.8rem; }
  
  .layout { display: flex; height: calc(100vh - 60px); }
  
  .sidebar { width: 320px; overflow-y: auto; border-right: 1px solid var(--border); flex-shrink: 0; }
  .sidebar-header { padding: 0.75rem 1rem; font-weight: 600; color: var(--muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
  
  .site-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; display: flex; align-items: center; justify-content: space-between; }
  .site-item:hover { background: rgba(79, 209, 197, 0.08); }
  .site-item.active { background: rgba(79, 209, 197, 0.15); border-left: 3px solid var(--accent); }
  .site-item.loading { opacity: 0.5; }
  .site-name { font-weight: 500; font-size: 0.9rem; }
  .site-meta { color: var(--muted); font-size: 0.75rem; margin-top: 2px; }
  .site-score { font-size: 1.1rem; min-width: 80px; text-align: right; }
  
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  
  #map { height: 300px; flex-shrink: 0; }
  
  .forecast-panel { flex: 1; overflow-y: auto; padding: 1.5rem; }
  
  .day-section { margin-bottom: 1.5rem; }
  .day-header { font-size: 1.1rem; font-weight: 600; padding: 0.5rem 0; border-bottom: 2px solid var(--border); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
  .day-label { color: var(--accent); }
  
  .hour-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .hour-table th { text-align: left; color: var(--muted); font-weight: 500; padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .hour-table td { padding: 0.35rem 0.5rem; border-bottom: 1px solid rgba(45,55,72,0.5); white-space: nowrap; }
  .hour-table tr:hover { background: rgba(79, 209, 197, 0.05); }
  
  .stars { letter-spacing: -2px; }
  .gradient-low { color: var(--good); }
  .gradient-med { color: var(--warn); }
  .gradient-high { color: var(--bad); }
  .rain { color: #63b3ed; }
  
  .summary-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
  .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; }
  .summary-card .label { color: var(--muted); font-size: 0.7rem; text-transform: uppercase; margin-bottom: 0.25rem; }
  .summary-card .value { font-size: 1.2rem; font-weight: 600; }
  
  .extended-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .extended-table th { text-align: left; color: var(--muted); font-weight: 500; padding: 0.5rem; border-bottom: 1px solid var(--border); }
  .extended-table td { padding: 0.5rem; border-bottom: 1px solid rgba(45,55,72,0.5); }
  
  .status-bar { padding: 0.5rem 1rem; background: var(--card); border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--muted); }
  
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--muted); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  @media (max-width: 768px) {
    .layout { flex-direction: column; }
    .sidebar { width: 100%; height: auto; max-height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
    #map { height: 200px; }
  }
</style>
</head>
<body>

<div class="header">
  <h1><span>ü™Ç</span> PG Forecast</h1>
  <div id="wasmStatus" style="font-size: 0.8rem; color: var(--muted);"><span class="spinner"></span> Loading WASM‚Ä¶</div>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-header">Sites</div>
    <div id="siteList"></div>
  </div>
  <div class="main">
    <div id="map"></div>
    <div class="forecast-panel" id="forecastPanel">
      <p style="color: var(--muted); text-align: center; padding: 3rem;">Select a site to view forecast</p>
    </div>
  </div>
</div>

<div class="status-bar" id="statusBar">Ready</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="wasm_exec.js"></script>
<script>
// === Sites database ===
const SITES = [
  { name: "Ballard Down", lat: 50.6308, lon: -1.9472, elevation: 100, wind_min: 140, wind_max: 185, best_dir: 170, aspect: 170 },
  { name: "Barton-on-Sea", lat: 50.7353, lon: -1.6594, elevation: 16, wind_min: 135, wind_max: 225, best_dir: 180, aspect: 180 },
  { name: "Bell Hill", lat: 50.8758, lon: -2.2883, elevation: 262, wind_min: 275, wind_max: 340, best_dir: 305, aspect: 305 },
  { name: "Bulbarrow", lat: 50.8514, lon: -2.3247, elevation: 250, wind_min: 210, wind_max: 240, best_dir: 225, aspect: 225 },
  { name: "Corton Denham", lat: 51.0083, lon: -2.5239, elevation: 211, wind_min: 210, wind_max: 280, best_dir: 245, aspect: 245 },
  { name: "Cowdown", lat: 50.7975, lon: -2.5136, elevation: 217, wind_min: 270, wind_max: 270, best_dir: 270, aspect: 270 },
  { name: "Friar Waddon", lat: 50.6672, lon: -2.5092, elevation: 100, wind_min: 180, wind_max: 180, best_dir: 180, aspect: 180 },
  { name: "Hambledon Hill", lat: 50.9130, lon: -2.2197, elevation: 180, wind_min: 22, wind_max: 68, best_dir: 45, aspect: 45 },
  { name: "Kimmeridge", lat: 50.6153, lon: -2.1053, elevation: 218, wind_min: 210, wind_max: 270, best_dir: 240, aspect: 240 },
  { name: "Knitson", lat: 50.6306, lon: -1.9928, elevation: 213, wind_min: 180, wind_max: 230, best_dir: 200, aspect: 200 },
  { name: "Maiden Castle", lat: 50.6967, lon: -2.4689, elevation: 115, wind_min: 330, wind_max: 30, best_dir: 0, aspect: 0 },
  { name: "Marley Combe", lat: 51.0028, lon: -1.9686, elevation: 200, wind_min: 315, wind_max: 360, best_dir: 337, aspect: 337 },
  { name: "Nine Barrow Down", lat: 50.6308, lon: -1.9867, elevation: 180, wind_min: 0, wind_max: 45, best_dir: 22, aspect: 22 },
  { name: "Okeford Hill", lat: 50.8847, lon: -2.2672, elevation: 246, wind_min: 5, wind_max: 40, best_dir: 30, aspect: 30 },
  { name: "Portland East", lat: 50.5458, lon: -2.4203, elevation: 125, wind_min: 60, wind_max: 120, best_dir: 75, aspect: 75 },
  { name: "Portland West", lat: 50.5550, lon: -2.4453, elevation: 131, wind_min: 270, wind_max: 315, best_dir: 295, aspect: 295 },
  { name: "Ringstead", lat: 50.6403, lon: -2.3425, elevation: 147, wind_min: 210, wind_max: 260, best_dir: 225, aspect: 225 },
  { name: "Southbourne", lat: 50.7214, lon: -1.8167, elevation: 50, wind_min: 160, wind_max: 200, best_dir: 180, aspect: 180 },
  { name: "St Aldhelm's", lat: 50.5922, lon: -2.0597, elevation: 125, wind_min: 225, wind_max: 270, best_dir: 247, aspect: 247 },
  { name: "Swallowcliffe", lat: 51.0300, lon: -2.0367, elevation: 205, wind_min: 290, wind_max: 335, best_dir: 315, aspect: 315 },
  { name: "White Horse", lat: 50.6586, lon: -2.4044, elevation: 140, wind_min: 180, wind_max: 220, best_dir: 200, aspect: 200 },
  { name: "Whitesheet", lat: 51.0133, lon: -2.0919, elevation: 225, wind_min: 260, wind_max: 280, best_dir: 270, aspect: 270 },
  { name: "Winkelbury", lat: 50.9928, lon: -2.0726, elevation: 269, wind_min: 275, wind_max: 340, best_dir: 310, aspect: 310 },
  { name: "Beer Head", lat: 50.6866, lon: -3.0999, elevation: 110, wind_min: 170, wind_max: 210, best_dir: 180, aspect: 180 },
  { name: "Eype", lat: 50.7150, lon: -2.7800, elevation: 130, wind_min: 180, wind_max: 225, best_dir: 200, aspect: 200 },
  { name: "Cogden", lat: 50.6950, lon: -2.7150, elevation: 50, wind_min: 180, wind_max: 225, best_dir: 200, aspect: 200 },
];

// === Open-Meteo API ===
const PRESSURE_LEVELS = [1000, 950, 925, 900, 850, 700];
const SURFACE_PARAMS = [
  'temperature_2m', 'relative_humidity_2m', 'dew_point_2m',
  'wind_speed_10m', 'wind_direction_10m', 'wind_gusts_10m',
  'cloud_cover', 'cloud_cover_low', 'cloud_cover_mid', 'cloud_cover_high',
  'cape', 'shortwave_radiation', 'precipitation', 'precipitation_probability',
  'freezing_level_height', 'is_day', 'weather_code', 'pressure_msl', 'visibility',
];

function buildOpenMeteoURL(lat, lon) {
  const pressureParams = PRESSURE_LEVELS.flatMap(p => [
    `wind_speed_${p}hPa`, `wind_direction_${p}hPa`, `temperature_${p}hPa`, `geopotential_height_${p}hPa`
  ]);
  const allParams = [...SURFACE_PARAMS, ...pressureParams].join(',');
  return `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=${allParams}&wind_speed_unit=mph&forecast_days=16&timezone=UTC`;
}

async function fetchWeather(site) {
  const url = buildOpenMeteoURL(site.lat, site.lon);
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`API ${resp.status}`);
  return await resp.text(); // Return raw JSON string for WASM
}

// === WASM loading ===
let wasmReady = false;

async function loadWasm() {
  const go = new Go();
  const result = await WebAssembly.instantiateStreaming(fetch('pgforecast.wasm'), go.importObject);
  go.run(result.instance);
  wasmReady = true;
  document.getElementById('wasmStatus').innerHTML = '‚úÖ WASM ready';
}

// === Map ===
let map, markers = {};
function initMap() {
  map = L.map('map').setView([50.78, -2.2], 10);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OpenStreetMap ¬© CARTO',
    maxZoom: 18
  }).addTo(map);

  SITES.forEach(site => {
    const marker = L.circleMarker([site.lat, site.lon], {
      radius: 8, fillColor: '#718096', color: '#2d3748', weight: 2, fillOpacity: 0.8
    }).addTo(map);
    marker.bindTooltip(site.name, { direction: 'top', offset: [0, -10] });
    marker.on('click', () => selectSite(site.name));
    markers[site.name] = marker;
  });
}

function updateMarkerColor(name, score) {
  const colors = { 1: '#f56565', 2: '#ed8936', 3: '#ecc94b', 4: '#48bb78', 5: '#38b2ac' };
  const marker = markers[name];
  if (marker) marker.setStyle({ fillColor: colors[score] || '#718096' });
}

// === UI ===
let selectedSite = null;
let siteForecasts = {};

function compassDir(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}

function starsHTML(n) {
  return '‚≠ê'.repeat(n);
}

function gradientClass(g) {
  if (g.includes('Low')) return 'gradient-low';
  if (g.includes('Medium')) return 'gradient-med';
  return 'gradient-high';
}

function gradientIcon(g) {
  if (g.includes('Low')) return '‚úÖ';
  if (g.includes('Medium')) return '‚ö†Ô∏è';
  return 'üî¥';
}

function thermalIcon(t) {
  const icons = { None: '‚ùÑÔ∏è', Weak: 'üå§', Moderate: '‚òÄÔ∏è', Strong: 'üî•', Extreme: '‚ö°' };
  return icons[t] || '‚ùì';
}

function cloudIcon(cover) {
  if (cover < 20) return '‚òÄÔ∏è';
  if (cover < 50) return '‚õÖ';
  if (cover < 80) return 'üå•';
  return '‚òÅÔ∏è';
}

function rainStr(precip, prob) {
  if (precip > 0) return `<span class="rain">üåß${precip.toFixed(1)}</span>`;
  if (prob > 30) return `${prob.toFixed(0)}%`;
  return '-';
}

function renderSiteList() {
  const el = document.getElementById('siteList');
  el.innerHTML = SITES.map(s => {
    const fc = siteForecasts[s.name];
    const active = selectedSite === s.name ? 'active' : '';
    const score = fc ? starsHTML(fc.bestScore) : '';
    return `<div class="site-item ${active}" onclick="selectSite('${s.name}')">
      <div><div class="site-name">${s.name}</div>
      <div class="site-meta">${compassDir(s.aspect)} facing ¬∑ ${s.elevation}m</div></div>
      <div class="site-score">${score}</div>
    </div>`;
  }).join('');
}

async function selectSite(name) {
  selectedSite = name;
  renderSiteList();
  
  const site = SITES.find(s => s.name === name);
  if (!site) return;
  
  map.flyTo([site.lat, site.lon], 12, { duration: 0.5 });
  
  const panel = document.getElementById('forecastPanel');
  
  if (siteForecasts[name]) {
    renderForecast(siteForecasts[name]);
    return;
  }
  
  panel.innerHTML = '<p style="text-align:center;padding:2rem;"><span class="spinner"></span> Fetching forecast‚Ä¶</p>';
  setStatus(`Fetching weather for ${name}‚Ä¶`);
  
  try {
    const weatherJSON = await fetchWeather(site);
    setStatus(`Computing metrics for ${name}‚Ä¶`);
    
    if (!wasmReady) {
      panel.innerHTML = '<p style="color:var(--bad);text-align:center;padding:2rem;">WASM not loaded yet</p>';
      return;
    }
    
    const siteJSON = JSON.stringify(site);
    const resultJSON = pgforecastWasm.computeMetrics(weatherJSON, siteJSON);
    const metrics = JSON.parse(resultJSON);
    
    if (metrics.error) {
      panel.innerHTML = `<p style="color:var(--bad);text-align:center;padding:2rem;">Error: ${metrics.error}</p>`;
      return;
    }
    
    // Group by day, filter 8-18h
    const days = groupByDay(metrics);
    const forecast = { site, days, bestScore: 0 };
    days.forEach(d => d.hours.forEach(h => { if (h.flyability_score > forecast.bestScore) forecast.bestScore = h.flyability_score; }));
    
    siteForecasts[name] = forecast;
    updateMarkerColor(name, forecast.bestScore);
    renderSiteList();
    renderForecast(forecast);
    setStatus(`${name} forecast loaded`);
  } catch (err) {
    panel.innerHTML = `<p style="color:var(--bad);text-align:center;padding:2rem;">Error: ${err.message}</p>`;
    setStatus(`Error: ${err.message}`);
  }
}

function groupByDay(metrics) {
  const dayMap = {};
  const order = [];
  metrics.forEach(m => {
    const dt = new Date(m.time);
    const key = dt.toISOString().slice(0, 10);
    const hour = dt.getUTCHours();
    if (hour < 8 || hour > 18) return;
    if (!dayMap[key]) { dayMap[key] = []; order.push(key); }
    dayMap[key].push(m);
  });
  return order.map(key => ({ date: key, hours: dayMap[key] }));
}

function renderForecast(forecast) {
  const panel = document.getElementById('forecastPanel');
  const days = forecast.days;
  const detailedDays = days.slice(0, 3);
  const extendedDays = days.slice(3);
  
  let html = '';
  
  // Detailed days
  detailedDays.forEach((day, i) => {
    const dt = new Date(day.date + 'T12:00:00Z');
    const label = i === 0 ? 'TODAY' : i === 1 ? 'TOMORROW' : dt.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
    const dayLabel = dt.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
    
    // Summary cards
    const midHour = day.hours[Math.floor(day.hours.length / 2)] || day.hours[0];
    const bestScore = Math.max(...day.hours.map(h => h.flyability_score));
    const cloudbaseFt = midHour ? Math.round((midHour.cloudbase_ft || 0)) : 0;
    
    html += `<div class="day-section">
      <div class="day-header"><span class="day-label">${label}</span> ${dayLabel}</div>
      <div class="summary-cards">
        <div class="summary-card"><div class="label">Best Score</div><div class="value">${starsHTML(bestScore)}</div></div>
        <div class="summary-card"><div class="label">Cloudbase</div><div class="value">${cloudbaseFt <= 200 ? 'Fog' : cloudbaseFt + 'ft'}</div></div>
        <div class="summary-card"><div class="label">CAPE</div><div class="value">${midHour ? midHour.cape.toFixed(0) : 0} J/kg</div></div>
        <div class="summary-card"><div class="label">XC Potential</div><div class="value">${midHour ? midHour.xc_potential : 'N/A'}</div></div>
      </div>
      <table class="hour-table">
        <tr><th>Time</th><th>Wind</th><th>Dir</th><th>Gust</th><th>Gradient</th><th>Thermal</th><th>Cloud</th><th>Rain</th><th>Score</th></tr>
        ${day.hours.map(h => {
          const dt = new Date(h.time);
          const timeStr = dt.getUTCHours().toString().padStart(2, '0') + ':00';
          return `<tr>
            <td>${timeStr}</td>
            <td>${h.wind_speed.toFixed(0)}mph</td>
            <td>${h.wind_dir_str}</td>
            <td>${h.wind_gusts.toFixed(0)}</td>
            <td class="${gradientClass(h.wind_gradient)}">${gradientIcon(h.wind_gradient)} ${h.wind_gradient}(+${h.wind_gradient_diff.toFixed(0)})</td>
            <td>${thermalIcon(h.thermal_rating)} ${h.thermal_rating}</td>
            <td>${cloudIcon(h.cloud_cover)}</td>
            <td>${rainStr(h.precipitation, h.precip_probability)}</td>
            <td class="stars">${starsHTML(h.flyability_score)}</td>
          </tr>`;
        }).join('')}
      </table>
    </div>`;
  });
  
  // Extended outlook
  if (extendedDays.length > 0) {
    html += `<div class="day-section">
      <div class="day-header"><span class="day-label">EXTENDED OUTLOOK</span></div>
      <table class="extended-table">
        <tr><th>Day</th><th>Wind</th><th>Dir</th><th>Thermal</th><th>Rain</th><th>Score</th></tr>
        ${extendedDays.map(day => {
          const dt = new Date(day.date + 'T12:00:00Z');
          const dayStr = dt.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
          const avgWind = day.hours.reduce((s, h) => s + h.wind_speed, 0) / day.hours.length;
          const avgDir = day.hours.reduce((s, h) => s + h.wind_direction, 0) / day.hours.length;
          const maxPrecip = Math.max(...day.hours.map(h => h.precip_probability));
          const bestThermal = ['None','Weak','Moderate','Strong','Extreme'][Math.max(...day.hours.map(h => ['None','Weak','Moderate','Strong','Extreme'].indexOf(h.thermal_rating)))];
          // Top 3 average for score
          const scores = day.hours.map(h => h.flyability_score).sort((a,b) => b-a);
          const top3 = scores.slice(0, 3);
          const avgScore = Math.round(top3.reduce((a,b) => a+b, 0) / top3.length);
          return `<tr>
            <td>${dayStr}</td>
            <td>${avgWind.toFixed(0)}mph</td>
            <td>${compassDir(avgDir)}</td>
            <td>${thermalIcon(bestThermal)} ${bestThermal}</td>
            <td>${maxPrecip.toFixed(0)}%</td>
            <td class="stars">${starsHTML(avgScore)}</td>
          </tr>`;
        }).join('')}
      </table>
    </div>`;
  }
  
  panel.innerHTML = html;
}

function setStatus(msg) {
  document.getElementById('statusBar').textContent = msg;
}

// === Load all sites overview ===
async function loadAllSitesOverview() {
  setStatus('Loading overview for all sites‚Ä¶');
  for (const site of SITES) {
    try {
      const weatherJSON = await fetchWeather(site);
      const siteJSON = JSON.stringify(site);
      const resultJSON = pgforecastWasm.computeMetrics(weatherJSON, siteJSON);
      const metrics = JSON.parse(resultJSON);
      if (!metrics.error) {
        const days = groupByDay(metrics);
        let bestScore = 0;
        days.slice(0, 3).forEach(d => d.hours.forEach(h => { if (h.flyability_score > bestScore) bestScore = h.flyability_score; }));
        siteForecasts[site.name] = { site, days, bestScore };
        updateMarkerColor(site.name, bestScore);
      }
    } catch (e) { /* skip failed sites */ }
    renderSiteList();
    setStatus(`Loaded ${site.name}`);
  }
  setStatus('All sites loaded');
}

// === Init ===
initMap();
renderSiteList();
loadWasm().then(() => {
  loadAllSitesOverview();
}).catch(err => {
  document.getElementById('wasmStatus').innerHTML = `‚ùå WASM error: ${err.message}`;
});
</script>
</body>
</html>
